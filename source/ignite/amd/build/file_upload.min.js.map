{"version":3,"file":"file_upload.min.js","sources":["../src/file_upload.js"],"sourcesContent":["import Ajax from 'core/ajax';\nimport Config from 'core/config';\nimport Log from 'core/log';\nimport Notification from 'core/notification';\n\nconst CHUNK_SIZE = 10 * 2 ** 20;\n\n/**\n * Handle uploading\n *\n * @param {object} data Data for upload\n */\nconst upload = async(data) => {\n    const file = document.querySelector('input[name=\"videofile\"]').files[0];\n    const parts = [];\n    let offset = 0;\n\n    for (let i = 0; i < data.parts.length; i++) {\n        parts.push({\n            PartNumber: data.parts[i].partNumber,\n            ETag: await uploadPart(file, data.parts[i], offset, data)\n        });\n        offset++;\n        document.querySelector('.progress').style.width = Math.min(CHUNK_SIZE * offset / file.size * 100, 100) + '%';\n    }\n\n    Ajax.call([{\n        args: {\n            id: data.id,\n            key: data.key,\n            parts: parts,\n            uploadid: data.uploadid\n        },\n        contextid: document.querySelector('input[name=\"contextid\"]').value,\n        done: () => {\n            const url = new URL(Config.wwwroot + '/admin/tool/mediatime');\n            url.searchParams.set('id', data.id);\n            window.location.href = url;\n        },\n        fail: Notification.exception,\n        methodname: 'mediatimesrc_ignite_finish_upload'\n    }]);\n};\n\n/**\n * Upload part\n *\n * @param {File} file File object\n * @param {Object} part Part to upload\n * @param {int} offset Index for part\n * @param {Object} data Upload url information\n * @returns {Object}\n */\nconst uploadPart = async(file, part, offset, data) => {\n    const request = new Request(part.url, {\n        body: file.slice(offset * CHUNK_SIZE, Math.min((offset * CHUNK_SIZE, file.size))),\n        method: 'PUT'\n    });\n    try {\n        const response = await fetch(request);\n        if (response && response.ok) {\n            return await JSON.parse(response.headers.get('Etag'));\n        }\n    } catch (e) {\n        Log.debug(e);\n    }\n    return await reattempt(file, part, offset, data);\n};\n\n/**\n * Reattempt failed partial upload\n *\n * @param {File} file File object\n * @param {Object} part Part to upload\n * @param {int} offset Index for part\n * @param {Object} data Upload url information\n * @returns {Object}\n */\nconst reattempt = async(file, part, offset, data) => {\n    await new Promise(resolve => setTimeout(resolve, 1000));\n    try {\n        const result = await Ajax.call([{\n                args: {\n                contextid: document.querySelector('input[name=\"contextid\"]').value,\n                key: data.key,\n                partnumber: part.partNumber,\n                uploadid: data.uploadid\n            },\n            contextid: document.querySelector('input[name=\"contextid\"]').value,\n            methodname: 'mediatimesrc_ignite_reattempt_upload'\n        }])[0];\n        part.url = result.url;\n        return await uploadPart(file, part, offset, data);\n    } catch (e) {\n        Log.debug(e);\n        return await reattempt(file, part, offset, data);\n    }\n};\n\nexport default {\n    /**\n     * Init event listeners\n     */\n    init: function() {\n        document.body.removeEventListener('click', this.handleClick);\n        document.body.addEventListener('click', this.handleClick);\n    },\n\n    /**\n     * Handle button click\n     *\n     * @param {Event} e Click event\n     */\n    handleClick: async function(e) {\n        const button = e.target.closest('button[name=\"upload\"]');\n        if (button) {\n            const file = document.querySelector('input[name=\"videofile\"]').files[0];\n            if (!file) {\n                Notification.alert('nofile', 'File missing');\n                return;\n            }\n            button.disabled = true;\n            e.preventDefault();\n            Log.debug(file);\n            const data = await Ajax.call([{\n                args: {\n                    filesize: Number(file.size),\n                    contextid: document.querySelector('input[name=\"contextid\"]').value,\n                    description: document.querySelector('input[name=\"description\"]').value,\n                    groupid: document.querySelector('input[name=\"groupid\"]').value || 0,\n                    mimetype: file.type,\n                    name: document.querySelector('input[name=\"name\"]').value,\n                    parts: Math.ceil(file.size / CHUNK_SIZE),\n                    tags: document.querySelector('input[name=\"tags\"]').value,\n                    title: document.querySelector('input[name=\"title\"]').value\n                },\n                contextid: document.querySelector('input[name=\"contextid\"]').value,\n                fail: Notification.exception,\n                methodname: 'mediatimesrc_ignite_create_token'\n            }])[0];\n            upload(data);\n        }\n    }\n};\n"],"names":["uploadPart","async","file","part","offset","data","request","Request","url","body","slice","Math","min","size","method","response","fetch","ok","JSON","parse","headers","get","e","debug","reattempt","Promise","resolve","setTimeout","result","Ajax","call","args","contextid","document","querySelector","value","key","partnumber","partNumber","uploadid","methodname","init","removeEventListener","this","handleClick","addEventListener","button","target","closest","files","alert","disabled","preventDefault","parts","i","length","push","PartNumber","ETag","style","width","id","done","URL","Config","wwwroot","searchParams","set","window","location","href","fail","Notification","exception","upload","filesize","Number","description","groupid","mimetype","type","name","ceil","tags","title"],"mappings":"6eAqDMA,WAAaC,MAAMC,KAAMC,KAAMC,OAAQC,cACnCC,QAAU,IAAIC,QAAQJ,KAAKK,IAAK,CAClCC,KAAMP,KAAKQ,MAlDA,SAkDMN,OAAqBO,KAAKC,IAA0BV,KAAKW,OAC1EC,OAAQ,kBAGFC,eAAiBC,MAAMV,YACzBS,UAAYA,SAASE,gBACRC,KAAKC,MAAMJ,SAASK,QAAQC,IAAI,SAEnD,MAAOC,gBACDC,MAAMD,gBAEDE,UAAUtB,KAAMC,KAAMC,OAAQC,OAYzCmB,UAAYvB,MAAMC,KAAMC,KAAMC,OAAQC,cAClC,IAAIoB,SAAQC,SAAWC,WAAWD,QAAS,iBAEvCE,aAAeC,cAAKC,KAAK,CAAC,CACxBC,KAAM,CACNC,UAAWC,SAASC,cAAc,2BAA2BC,MAC7DC,IAAK/B,KAAK+B,IACVC,WAAYlC,KAAKmC,WACjBC,SAAUlC,KAAKkC,UAEnBP,UAAWC,SAASC,cAAc,2BAA2BC,MAC7DK,WAAY,0CACZ,UACJrC,KAAKK,IAAMoB,OAAOpB,UACLR,WAAWE,KAAMC,KAAMC,OAAQC,MAC9C,MAAOiB,uBACDC,MAAMD,SACGE,UAAUtB,KAAMC,KAAMC,OAAQC,qBAIpC,CAIXoC,KAAM,WACFR,SAASxB,KAAKiC,oBAAoB,QAASC,KAAKC,aAChDX,SAASxB,KAAKoC,iBAAiB,QAASF,KAAKC,cAQjDA,YAAa3C,eAAeqB,SAClBwB,OAASxB,EAAEyB,OAAOC,QAAQ,4BAC5BF,OAAQ,OACF5C,KAAO+B,SAASC,cAAc,2BAA2Be,MAAM,OAChE/C,uCACYgD,MAAM,SAAU,gBAGjCJ,OAAOK,UAAW,EAClB7B,EAAE8B,8BACE7B,MAAMrB,MA/GPD,OAAAA,aACLC,KAAO+B,SAASC,cAAc,2BAA2Be,MAAM,GAC/DI,MAAQ,OACVjD,OAAS,MAER,IAAIkD,EAAI,EAAGA,EAAIjD,KAAKgD,MAAME,OAAQD,IACnCD,MAAMG,KAAK,CACPC,WAAYpD,KAAKgD,MAAMC,GAAGhB,WAC1BoB,WAAY1D,WAAWE,KAAMG,KAAKgD,MAAMC,GAAIlD,OAAQC,QAExDD,SACA6B,SAASC,cAAc,aAAayB,MAAMC,MAAQjD,KAAKC,IAlB5C,SAkB6DR,OAASF,KAAKW,KAAO,IAAK,KAAO,kBAGxGiB,KAAK,CAAC,CACPC,KAAM,CACF8B,GAAIxD,KAAKwD,GACTzB,IAAK/B,KAAK+B,IACViB,MAAOA,MACPd,SAAUlC,KAAKkC,UAEnBP,UAAWC,SAASC,cAAc,2BAA2BC,MAC7D2B,KAAM,WACItD,IAAM,IAAIuD,IAAIC,gBAAOC,QAAU,yBACrCzD,IAAI0D,aAAaC,IAAI,KAAM9D,KAAKwD,IAChCO,OAAOC,SAASC,KAAO9D,KAE3B+D,KAAMC,sBAAaC,UACnBjC,WAAY,wCAoGRkC,OAhBmB7C,cAAKC,KAAK,CAAC,CAC1BC,KAAM,CACF4C,SAAUC,OAAO1E,KAAKW,MACtBmB,UAAWC,SAASC,cAAc,2BAA2BC,MAC7D0C,YAAa5C,SAASC,cAAc,6BAA6BC,MACjE2C,QAAS7C,SAASC,cAAc,yBAAyBC,OAAS,EAClE4C,SAAU7E,KAAK8E,KACfC,KAAMhD,SAASC,cAAc,sBAAsBC,MACnDkB,MAAO1C,KAAKuE,KAAKhF,KAAKW,KA/HvB,UAgICsE,KAAMlD,SAASC,cAAc,sBAAsBC,MACnDiD,MAAOnD,SAASC,cAAc,uBAAuBC,OAEzDH,UAAWC,SAASC,cAAc,2BAA2BC,MAC7DoC,KAAMC,sBAAaC,UACnBjC,WAAY,sCACZ"}